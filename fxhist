#!/usr/bin/python
import os
import sys
import argparse
import glob
import sqlite3

parser = argparse.ArgumentParser(description='print Firefox histories')
parser.add_argument('num_records', metavar='N', type=int, nargs=1,
                    help='number of records')
parser.add_argument('-e', '--excludeurl', metavar='PATTERN',
                    help='exclude URLs which matches to PATTERN')
args = parser.parse_args()

dbfile_ptn = '~/.mozilla/firefox/*.default/places.sqlite'
dbfile = glob.glob(os.path.expanduser(dbfile_ptn));
if len(dbfile) == 0:
    sys.stderr.write('database not found')
    exit(1)

con = sqlite3.connect(dbfile[0])
cur = con.cursor()

if args.excludeurl:
    cur.execute('SELECT p.title, p.url FROM moz_historyvisits AS h INNER JOIN moz_places AS p ON h.place_id = p.id WHERE p.url NOT LIKE ? ORDER BY h.id DESC LIMIT ?', (args.excludeurl, args.num_records[0]))
else:
    cur.execute('SELECT p.title, p.url FROM moz_historyvisits AS h INNER JOIN moz_places AS p ON h.place_id = p.id ORDER BY h.id DESC LIMIT ?', (args.num_records[0],))

for row in cur:
    print ((row[0] or '') + ' / ' + row[1]).encode('utf-8')

con.close()
